#!/usr/bin/env bash
set -euo pipefail

# Hard gate: block commits if a high-confidence secret is found in tracked files.
# This is defense-in-depth; GitHub Actions is the authoritative gate.

cd "$(git rev-parse --show-toplevel)"

echo "üîí Wingman secret scan (pre-commit): scanning tracked files..."

fail=0

# Scan only tracked files (prevents noise from local .env files)
tracked_files() {
  git ls-files -z
}

scan_with_rg() {
  local label="$1"
  local regex="$2"
  if tracked_files | xargs -0 rg -n --no-heading --hidden --glob '!.git/**' -e "$regex" >/dev/null 2>&1; then
    echo "‚ùå Secret scan failed: $label"
    # Print only file:line (no match content) to avoid leaking secrets into terminal logs.
    tracked_files | xargs -0 rg -n --no-heading --hidden --glob '!.git/**' -e "$regex" | cut -d: -f1-2 | head -n 200
    fail=1
  fi
}

scan_with_python() {
  local label="$1"
  local regex="$2"
  python3 - <<PY
import re, subprocess, sys
pat=re.compile(r"""$regex""", re.MULTILINE)
files=subprocess.check_output(["git","ls-files"], text=True).splitlines()
hits=[]
for f in files:
  try:
    b=open(f,"rb").read()
  except Exception:
    continue
  s=b.decode("utf-8","ignore")
  m=pat.search(s)
  if m:
    line=s.count("\\n",0,m.start())+1
    hits.append((f,line))
if hits:
  print("‚ùå Secret scan failed:", "$label")
  for f,line in hits[:200]:
    print(f"{f}:{line}")
  sys.exit(2)
PY
  if [[ "${PIPESTATUS[0]}" -ne 0 ]]; then
    fail=1
  fi
}

scan() {
  local label="$1"
  local regex="$2"
  if command -v rg >/dev/null 2>&1; then
    scan_with_rg "$label" "$regex"
  else
    scan_with_python "$label" "$regex"
  fi
}

# Telegram bot token-like pattern (digits:token)
scan "telegram_token_like" '\\b[0-9]{7,12}:[A-Za-z0-9_-]{20,}\\b'

# Private key blocks
scan "private_key_block" '-----BEGIN (RSA |EC |OPENSSH |)PRIVATE KEY-----'

# AWS access key id
scan "aws_access_key_like" '\\bAKIA[0-9A-Z]{16}\\b'

# OpenAI key-like (legacy pattern; still worth flagging)
scan "openai_key_like" '\\bsk-[A-Za-z0-9]{20,}\\b'

# Hardcoded CLIENT_SECRET assignments in code/docs/scripts
scan "client_secret_assign" 'CLIENT_SECRET\\s*=\\s*\"[^\"]{10,}\"'

# Bearer tokens in docs/snippets
scan "authorization_bearer" 'Authorization:\\s*Bearer\\s+[^\\s]+'

if [[ "$fail" -ne 0 ]]; then
  echo ""
  echo "üõë Commit blocked: remove secrets from tracked files."
  echo "   Put secrets in .env.* (untracked) and use placeholders in docs/examples."
  exit 1
fi

echo "‚úÖ Secret scan passed"
