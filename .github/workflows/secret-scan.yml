name: secret-scan

on:
  push:
  pull_request:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Block tracked .env files (non-bypassable gate)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import re
          import subprocess
          import sys

          # If any .env-like file is tracked, fail CI immediately.
          # This blocks "agent publishes .env to GitHub" even if local git hooks are bypassed.
          rx = re.compile(r"(^|/)\.env(\.|$)|(^|/)\.env\.[A-Za-z0-9_-]+$|\.un\.env|un\.env", re.IGNORECASE)
          out = subprocess.check_output(["git", "ls-files", "-z"])
          files = [f for f in out.decode("utf-8", errors="ignore").split("\0") if f]
          bad = [f for f in files if rx.search(f)]
          if bad:
              print("‚ùå Forbidden env file(s) tracked by git (must be local-only; never committed):")
              for f in bad[:200]:
                  print("-", f)
              sys.exit(2)
          print("‚úÖ No tracked .env / un.env files detected")
          PY

      - name: Secret scan (tracked files)
        shell: bash
        run: |
          set -euo pipefail
          echo "üîí Secret scan: scanning git-tracked files..."

          scan() {
            local label="$1"
            local regex="$2"
            if git ls-files -z | xargs -0 rg -n --no-heading -e "$regex" >/dev/null 2>&1; then
              echo "‚ùå Secret scan failed: $label"
              git ls-files -z | xargs -0 rg -n --no-heading -e "$regex" | cut -d: -f1-2 | head -n 200
              exit 1
            fi
          }

          scan "telegram_token_like" '\\b[0-9]{7,12}:[A-Za-z0-9_-]{20,}\\b'
          scan "private_key_block" '-----BEGIN (RSA |EC |OPENSSH |)PRIVATE KEY-----'
          scan "aws_access_key_like" '\\bAKIA[0-9A-Z]{16}\\b'
          scan "github_pat_like" '\\bghp_[A-Za-z0-9]{30,}\\b'
          scan "openai_key_like" '\\bsk-[A-Za-z0-9]{20,}\\b'
          scan "client_secret_assign" 'CLIENT_SECRET\\s*=\\s*\"[^\"]{10,}\"'
          scan "generic_token_or_secret_assign" '(?i)\\b(api[_-]?key|token|client[_-]?secret|secret|access[_-]?token|refresh[_-]?token)\\b\\s*[:=]\\s*[\"\\x27]?[A-Za-z0-9_\\-\\/+\\.]{16,}[\"\\x27]?'
          scan "authorization_bearer" 'Authorization:\\s*Bearer\\s+[^\\s]+'

          echo "‚úÖ Secret scan passed"
