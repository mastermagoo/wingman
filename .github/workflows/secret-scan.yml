name: secret-scan

on:
  push:
  pull_request:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Secret scan (tracked files)
        shell: bash
        run: |
          set -euo pipefail
          echo "üîí Secret scan: scanning git-tracked files..."

          files="$(git ls-files)"

          scan() {
            local label="$1"
            local regex="$2"
            if rg -n --no-heading -e "$regex" $files >/dev/null 2>&1; then
              echo "‚ùå Secret scan failed: $label"
              rg -n --no-heading -e "$regex" $files | cut -d: -f1-2 | head -n 200
              exit 1
            fi
          }

          scan "telegram_token_like" '\\b[0-9]{7,12}:[A-Za-z0-9_-]{20,}\\b'
          scan "private_key_block" '-----BEGIN (RSA |EC |OPENSSH |)PRIVATE KEY-----'
          scan "aws_access_key_like" '\\bAKIA[0-9A-Z]{16}\\b'
          scan "openai_key_like" '\\bsk-[A-Za-z0-9]{20,}\\b'
          scan "client_secret_assign" 'CLIENT_SECRET\\s*=\\s*\"[^\"]{10,}\"'
          scan "authorization_bearer" 'Authorization:\\s*Bearer\\s+[^\\s]+'

          echo "‚úÖ Secret scan passed"
