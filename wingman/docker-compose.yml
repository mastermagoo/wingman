name: wingman-test

services:
  # Wingman API Service
  wingman-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    # Load TEST secrets/config (local-only). Secrets must NOT be hardcoded in compose; use .env.test (never committed).
    env_file:
      - .env.test
    environment:
      - FLASK_ENV=${FLASK_ENV:-development}
      - API_PORT=${API_PORT:-5000}
      - DEPLOYMENT_ENV=${DEPLOYMENT_ENV:-test}
      - WINGMAN_CONSENSUS_ENABLED=${WINGMAN_CONSENSUS_ENABLED:-1}
      - WINGMAN_CONSENSUS_OLLAMA_ENABLED=${WINGMAN_CONSENSUS_OLLAMA_ENABLED:-0}
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-wingman}
      - DB_USER=${DB_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      # Timescale/DB logging (intel_integration.py uses TIMESCALE_* env vars)
      - TIMESCALE_HOST=${TIMESCALE_HOST:-postgres}
      - TIMESCALE_PORT=${TIMESCALE_PORT:-5432}
      - TIMESCALE_DB=${TIMESCALE_DB:-wingman}
      - TIMESCALE_USER=${TIMESCALE_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - OLLAMA_HOST=${OLLAMA_HOST:-ollama}
      - OLLAMA_PORT=${OLLAMA_PORT:-11434}
      # mem0 Configuration (loaded from .env.test)
      - MEM0_API_URL=${MEM0_API_URL:-http://127.0.0.1:18888}
      - MEM0_USER_ID=${MEM0_USER_ID:-wingman}
      # OpenAI API Key (for AI workers - loaded from .env.test)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Anthropic API Key (for AI workers - loaded from .env.test)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Store sqlite approval DB in a writable path inside the container for TEST
      # (bind/named volumes often mount as root:root and break sqlite for non-root user).
      - WINGMAN_APPROVAL_DB=${WINGMAN_APPROVAL_DB:-/tmp/approvals.db}
      # Phase 4 (HITL) auth keys loaded from env_file (.env.test) - do NOT override here
      # as env_file values would be replaced with empty strings from shell interpolation.
      # Phase 5 (Execution Gateway) JWT secret for capability tokens - loaded from .env.test
    ports:
      # Host port 5000 is commonly occupied on macOS (AirPlay/AirTunes). Default to 5002.
      - "127.0.0.1:${WINGMAN_TEST_HOST_PORT:-8101}:5000"
    depends_on:
      - postgres
      - redis
      - ollama
    networks:
      - wingman-network
    # No host/bind volumes in TEST by default (prevents permission issues and reduces secret exposure).
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Telegram Bot Service
  telegram-bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    # Load TEST bot config (BOT_TOKEN/CHAT_ID + minimal approval keys)
    # NOTE: env_file does not participate in Compose interpolation, so we avoid ${BOT_TOKEN} here.
    env_file:
      - .env.test
    environment:
      - API_URL=${API_URL:-http://wingman-api:5000}
      - GATEWAY_URL=${GATEWAY_URL:-http://execution-gateway:5001}
      # Bot approval keys loaded from env_file (.env.test) - do NOT override here
      # as env_file values would be replaced with empty strings from shell interpolation.
      - ALLOWED_USERS=${ALLOWED_USERS:-}
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-wingman}
      - DB_USER=${DB_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      # Timescale/DB logging (intel_integration.py uses TIMESCALE_* env vars)
      - TIMESCALE_HOST=${TIMESCALE_HOST:-postgres}
      - TIMESCALE_PORT=${TIMESCALE_PORT:-5432}
      - TIMESCALE_DB=${TIMESCALE_DB:-wingman}
      - TIMESCALE_USER=${TIMESCALE_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      - DEPLOYMENT_ENV=${DEPLOYMENT_ENV:-test}
    depends_on:
      - wingman-api
      - postgres
    networks:
      - wingman-network
    # No host/bind volumes in TEST by default.
    restart: unless-stopped

  # Wingman Watcher - Phase 4: Autonomous Monitoring + Approval Notifications
  wingman-watcher:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: ["python", "-u", "wingman_watcher.py"]
    env_file:
      - .env.test
    environment:
      - WINGMAN_AUDIT_LOG=${WINGMAN_AUDIT_LOG:-data/claims_audit.jsonl}
      - WINGMAN_WATCHER_STATE=${WINGMAN_WATCHER_STATE:-data/watcher_state.json}
      - WINGMAN_WATCHER_INCIDENTS=${WINGMAN_WATCHER_INCIDENTS:-data/incidents.jsonl}
      - WINGMAN_WATCHER_INTERVAL_SEC=${WINGMAN_WATCHER_INTERVAL_SEC:-2.0}
      - WINGMAN_WATCHER_DEDUP_SEC=${WINGMAN_WATCHER_DEDUP_SEC:-600}
      - WINGMAN_NOTIFY_BACKENDS=${WINGMAN_NOTIFY_BACKENDS:-stdout,telegram}
      - WINGMAN_WEBHOOK_URL=${WINGMAN_WEBHOOK_URL:-}
      # TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID loaded from env_file
      # Approval queue monitoring (new feature)
      - WINGMAN_API_URL=${WINGMAN_API_URL:-http://wingman-api:5000}
      - WINGMAN_APPROVAL_CHECK_INTERVAL_SEC=${WINGMAN_APPROVAL_CHECK_INTERVAL_SEC:-30}
      - WINGMAN_APPROVAL_NOTIFY_ENABLED=${WINGMAN_APPROVAL_NOTIFY_ENABLED:-true}
      # WINGMAN_APPROVAL_READ_KEY loaded from env_file
      - DEPLOYMENT_ENV=${DEPLOYMENT_ENV:-test}
    depends_on:
      - wingman-api
    networks:
      - wingman-network
    restart: unless-stopped
    # Watcher is not an HTTP server; disable the inherited Dockerfile healthcheck.
    healthcheck:
      disable: true


  # Phase R0: Execution Gateway (TEST-only)
  # The ONLY service with Docker socket access.
  execution-gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    env_file:
      - .env.test
    environment:
      - ALLOWED_ENVIRONMENTS=${ALLOWED_ENVIRONMENTS:-test}
      - GATEWAY_PORT=${GATEWAY_PORT:-5001}
      - AUDIT_STORAGE=${AUDIT_STORAGE:-postgres}
      # Database connection for audit logs
      - POSTGRES_HOST=${DB_HOST:-postgres}
      - POSTGRES_PORT=${DB_PORT:-5432}
      - POSTGRES_DB=${DB_NAME:-wingman}
      - POSTGRES_USER=${DB_USER:-wingman}
      # POSTGRES_PASSWORD and GATEWAY_JWT_SECRET loaded from .env.test
      - DEPLOYMENT_ENV=test
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - wingman-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL with TimescaleDB
  postgres:
    image: timescale/timescaledb:latest-pg15
    # Load TEST secrets/config (local-only). Ensure POSTGRES_PASSWORD is set in .env.test (never committed).
    env_file:
      - .env.test
    environment:
      - POSTGRES_USER=${DB_USER:-wingman}
      - POSTGRES_DB=${DB_NAME:-wingman}
      - POSTGRES_HOST_AUTH_METHOD=${POSTGRES_HOST_AUTH_METHOD:-md5}
    # Do not publish Postgres port in TEST by default to avoid host port conflicts.
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database_schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    networks:
      - wingman-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-wingman} -d ${DB_NAME:-wingman}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    # Do not publish Redis port in TEST by default to avoid host port conflicts.
    volumes:
      - redis_data:/data
    networks:
      - wingman-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ollama for Mistral 7B
  ollama:
    image: ollama/ollama:latest
    # Do not publish the Ollama port in TEST by default; it often collides with
    # other Ollama instances already bound to 11434 on the host. Wingman API
    # reaches Ollama over the Docker network via service name `ollama:11434`.
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - wingman-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
    healthcheck:
      # Note: ollama/ollama image does NOT include curl, use ollama CLI instead
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  wingman-network:
    driver: bridge
    # TEST network is self-managed to avoid “missing stack” after OrbStack resets/prunes.
    name: wingman-network-test

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  ollama_data:
    driver: local