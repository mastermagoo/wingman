name: wingman-test

services:
  # Wingman API Service
  wingman-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    # Load TEST secrets/config (kept out of git via .gitignore / globalignore)
    env_file:
      - .env.test
    environment:
      - FLASK_ENV=${FLASK_ENV:-development}
      - API_PORT=${API_PORT:-5000}
      - DEPLOYMENT_ENV=${DEPLOYMENT_ENV:-dev}
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-wingman}
      - DB_USER=${DB_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      - DB_PASSWORD=${DB_PASSWORD:-wingman_secure_pass}
      # Timescale/DB logging (intel_integration.py uses TIMESCALE_* env vars)
      - TIMESCALE_HOST=${TIMESCALE_HOST:-postgres}
      - TIMESCALE_PORT=${TIMESCALE_PORT:-5432}
      - TIMESCALE_DB=${TIMESCALE_DB:-wingman}
      - TIMESCALE_USER=${TIMESCALE_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      - TIMESCALE_PASS=${TIMESCALE_PASS:-wingman_secure_pass}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - OLLAMA_HOST=${OLLAMA_HOST:-ollama}
      - OLLAMA_PORT=${OLLAMA_PORT:-11434}
      # Store sqlite approval DB in a writable path inside the container for TEST
      # (bind/named volumes often mount as root:root and break sqlite for non-root user).
      - WINGMAN_APPROVAL_DB=${WINGMAN_APPROVAL_DB:-/tmp/approvals.db}
      # Phase 4 (HITL) auth keys loaded from env_file (.env.test) - do NOT override here
      # as env_file values would be replaced with empty strings from shell interpolation.
    ports:
      # Host port 5000 is commonly occupied on macOS (AirPlay/AirTunes). Default to 5002.
      - "127.0.0.1:${API_PORT:-5002}:5000"
    depends_on:
      - postgres
      - redis
      - ollama
    networks:
      - wingman-network
    # No host/bind volumes in TEST by default (prevents permission issues and reduces secret exposure).
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Telegram Bot Service
  telegram-bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    # Load TEST bot config (BOT_TOKEN/CHAT_ID + minimal approval keys)
    # NOTE: env_file does not participate in Compose interpolation, so we avoid ${BOT_TOKEN} here.
    env_file:
      - .env.test
    environment:
      - API_URL=${API_URL:-http://wingman-api:5000}
      # Bot approval keys loaded from env_file (.env.test) - do NOT override here
      # as env_file values would be replaced with empty strings from shell interpolation.
      - ALLOWED_USERS=${ALLOWED_USERS:-}
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-wingman}
      - DB_USER=${DB_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      - DB_PASSWORD=${DB_PASSWORD:-wingman_secure_pass}
      # Timescale/DB logging (intel_integration.py uses TIMESCALE_* env vars)
      - TIMESCALE_HOST=${TIMESCALE_HOST:-postgres}
      - TIMESCALE_PORT=${TIMESCALE_PORT:-5432}
      - TIMESCALE_DB=${TIMESCALE_DB:-wingman}
      - TIMESCALE_USER=${TIMESCALE_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      - TIMESCALE_PASS=${TIMESCALE_PASS:-wingman_secure_pass}
      - DEPLOYMENT_ENV=${DEPLOYMENT_ENV:-dev}
    depends_on:
      - wingman-api
      - postgres
    networks:
      - wingman-network
    # No host/bind volumes in TEST by default.
    restart: unless-stopped

  # PostgreSQL with TimescaleDB
  postgres:
    image: timescale/timescaledb:latest-pg15
    environment:
      - POSTGRES_USER=${DB_USER:-wingman}
      # TEST: avoid hard failure during Compose interpolation (env_file is not used for interpolation).
      - POSTGRES_PASSWORD=${DB_PASSWORD:-wingman_secure_pass}
      - POSTGRES_DB=${DB_NAME:-wingman}
      - POSTGRES_HOST_AUTH_METHOD=${POSTGRES_HOST_AUTH_METHOD:-md5}
    # Do not publish Postgres port in TEST by default to avoid host port conflicts.
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database_schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    networks:
      - wingman-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-wingman} -d ${DB_NAME:-wingman}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    # Do not publish Redis port in TEST by default to avoid host port conflicts.
    volumes:
      - redis_data:/data
    networks:
      - wingman-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ollama for Mistral 7B
  ollama:
    image: ollama/ollama:latest
    # Do not publish the Ollama port in TEST by default; it often collides with
    # other Ollama instances already bound to 11434 on the host. Wingman API
    # reaches Ollama over the Docker network via service name `ollama:11434`.
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - wingman-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
    healthcheck:
      # Note: ollama/ollama image does NOT include curl, use ollama CLI instead
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  wingman-network:
    driver: bridge
    # TEST network is self-managed to avoid “missing stack” after OrbStack resets/prunes.
    name: wingman-network-test

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  ollama_data:
    driver: local